{% extends "_layout.html" %}
{% set title = "Moje vožnje – Skupni prevozi" %}

{% block content %}
<section class="page">
  <div class="wrap">
    <div class="card">
      <h2>Moje vožnje</h2>
      <p class="muted">Tukaj vidiš svoje vožnje. Klikni “Izbriši” za odstranitev.</p>

      <div id="voznje-container">
        <p>Nalaganje voženj...</p>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => naloziVoznje());

async function naloziVoznje() {
  const container = document.getElementById('voznje-container');
  container.innerHTML = '<p>Nalaganje voženj...</p>';

  try {
    const res = await fetch('/api/moje_voznje');
    const data = await res.json();
    container.innerHTML = '';

    if (data.success && data.voznje.length > 0) {
      const list = document.createElement('ul');

      data.voznje.forEach(v => {
        const item = document.createElement('li');

        item.innerHTML = `
          <div class="ride-row">
            <div class="ride-main">
              <div class="ride-title">
                <strong>${esc(v.zacetek)}</strong> → <strong>${esc(v.destinacija)}</strong>
              </div>
              <div class="ride-meta">
                Datum: ${esc(v.datum)} ob ${esc(v.cas)} • Sedeži: ${esc(String(v.sedezi))} • Cena: ${esc(String(v.cena))} €
                <br>Telefon: ${esc(v.telefonska || '')}
              </div>
            </div>

            <div class="ride-actions">
              <button class="danger" onclick="izbrisiVoznjo(${v.doc_id})">Izbriši</button>
            </div>
          </div>
        `;
        list.appendChild(item);
      });

      container.appendChild(list);
    } else {
      container.innerHTML = '<p>Trenutno še nimaš vnešenih voženj.</p>';
    }
  } catch (e) {
    console.error(e);
    container.innerHTML = '<p>Napaka pri nalaganju.</p>';
  }
}

async function izbrisiVoznjo(id) {
  if (!confirm("Ali res želiš izbrisati to vožnjo?")) return;

  const res = await fetch(`/izbrisi_voznjo/${id}`, { method: 'POST' });
  const json = await res.json();

  if (json.success) naloziVoznje();
  else alert("Napaka: " + (json.error || "neznano"));
}

function esc(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
</script>
{% endblock %}
